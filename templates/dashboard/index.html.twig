{% extends 'base.html.twig' %}
{% block body %}
    <div class="d-flex align-items-center mb-3 gap-2">
        <form method="get" action="{{ path('app_dashboard') }}" class="me-2">
            <select name="crypto" class="form-select" onchange="this.form.submit()">
                {% for a in ['BTC','SOL','ETH'] %}
                    <option value="{{ a }}" {{ a==crypto ? 'selected' }}>{{ a }}</option>
                {% endfor %}
            </select>
        </form>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#txModal">Ajouter une opération</button>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <canvas id="dcaChart" height="110"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Opérations {{ crypto }}</div>
        <div class="card-body p-0">
            <table class="table table-sm table-striped mb-0">
                <thead><tr>
                    <th>Date</th><th>Type</th><th>Qté</th><th>Prix USD</th><th>Frais</th><th>Montant</th><th>Note</th>
                </tr></thead>
                <tbody>
                {% for t in transactions %}
                    <tr>
                        <td>{{ t.date|date('Y-m-d') }}</td>
                        <td>{{ t.type }}</td>
                        <td>{{ t.quantity }}</td>
                        <td>{{ t.unitPriceUsd ?? '—' }}</td>
                        <td>{{ t.feeUsd ?? '—' }}</td>
                        <td>
                            {% set invested = (t.type=='BUY' and t.unitPriceUsd) ? (t.unitPriceUsd * t.quantity + (t.feeUsd ?? 0)) : 0 %}
                            {{ invested ? invested|number_format(2, '.', ' ') : '—' }}
                        </td>
                        <td>{{ t.note ?? '' }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="7" class="text-center py-3 text-muted">Aucune opération</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {# Modale #}
    <div class="modal fade" id="txModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Nouvelle opération {{ crypto }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    {{ include('transaction/_form.html.twig', { form: form, crypto: crypto }) }}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        (async function() {
            const res = await fetch('{{ path('api_series', {symbol: crypto}) }}');
            const data = await res.json();
            const ctx = document.getElementById('dcaChart');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        { label: 'Quantité cumulée', data: data.quantityCumulative, tension: 0.2 },
                        { label: 'Investi cumulé (USD)', data: data.investedCumulative, yAxisID: 'y1', tension: 0.2 }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    stacked: false,
                    scales: {
                        y: { title: { display: true, text: 'Quantité' } },
                        y1: { position: 'right', title: { display: true, text: 'USD' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        })();
    </script>
{% endblock %}
